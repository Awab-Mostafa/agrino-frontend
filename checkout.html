<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vodafone Cash Payment</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Google Fonts and Boxicons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>

    <style>
      /* Additional styling for the payment page */
      .checkout-item{
        display:flex;align-items:center;justify-content:flex-start;
        border:1px solid #2a2a2a;padding:1rem;margin:1rem 0;border-radius:.5rem;
        background:rgba(255,255,255,.03)
      }
      .checkout-item img{width:100px;height:auto;margin-right:1rem;border-radius:.4rem}
      .checkout-details{text-align:left}

      /* نموذج الدفع */
      form#payment-form{
        background:transparent;
        padding:1.5rem;max-width:520px;margin:0 auto;text-align:left
      }
      form#payment-form .input-box{margin-bottom:1rem}
      form#payment-form label{
        display:block;margin-bottom:.5rem;font-weight:700;color:#fff;font-size:1.2rem
      }
      form#payment-form input{
        width:100%;padding:.6rem .8rem;background-color:#3A7D5C;border:none;border-radius:.3rem;color:#fff;font-size:1.05rem
      }
      form#payment-form h3{color:#fff;font-size:1.6rem;margin-bottom:1rem}
      .heading{font-size:2.5rem;color:#fff}
      .muted{color:#bbb;font-size:.95rem}
      .error{color:#ff6b6b;margin-top:.8rem}
      .success{color:#7dffb3;margin-top:.8rem}
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <a href="index.html" class="logo">Our <span>Project</span></a>
      <nav class="navbar">
        <a href="index.html#home">Home</a>
        <a href="index.html#about">About</a>
        <a href="index.html#services">SDGs</a>
        <a href="index.html#projects">Previous Solutions</a>
        <a href="index.html#ourteam">Our Team</a>
      </nav>
      <div class="header-buttons">
        <button class="gradient-btn">
          <a href="index.html#contact" class="gradient-btn">Contact Us</a>
        </button>
      </div>
    </header>

    <!-- Checkout Section -->
    <section class="checkout-section" style="padding-top: 10rem; text-align: center;">
      <h2 class="heading">Vodafone Cash Payment</h2>

      <!-- Selected products -->
      <div id="payment-details"></div>

      <!-- Total -->
      <div id="total-section" style="margin-top: 1.5rem;"></div>

      <!-- Payment form -->
      <form id="payment-form" style="margin-top: 2rem;">
        <h3>Payment Details</h3>

        <p class="muted" style="margin:.2rem 0 1rem;">
          *سيتم إنشاء طلب شراء وتأكيده يدويًا بعد الدفع عبر فودافون كاش.
        </p>

        <div class="input-box">
          <label for="name">Name:</label>
          <input type="text" id="name" placeholder="Enter your name" required />
        </div>
        <div class="input-box">
          <label for="phone">Phone Number:</label>
          <input type="text" id="phone" placeholder="Enter your phone number" required />
        </div>
        <div class="input-box">
          <label for="address">Address:</label>
          <input type="text" id="address" placeholder="Enter your address" required />
        </div>
        <div class="input-box">
          <label for="vodafone-number">Vodafone Cash Number:</label>
          <input type="text" id="vodafone-number" placeholder="Enter your Vodafone Cash number" required />
        </div>

        <button type="submit" class="card-btn" style="margin-top: 1rem;">Confirm Payment</button>
        <div id="form-msg" class="muted" style="margin-top:.6rem;"></div>
      </form>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <p>&copy; 2025 Jonathan. All Rights Reserved.</p>
    </footer>

    <!-- عرض عناصر السلة والتوتال -->
    <script>
      function egp(n){ return `${Number(n||0).toLocaleString('ar-EG')} EGP`; }

      function displayPaymentDetails(){
        const paymentContainer = document.getElementById("payment-details");
        const totalEl = document.getElementById("total-section");
        const cartItems = JSON.parse(localStorage.getItem("cartItems") || "[]");

        if (!cartItems.length){
          paymentContainer.innerHTML = "<p style='font-size:2rem;color:#fff'>No items in cart</p>";
          totalEl.innerHTML = "";
          return;
        }

        let html = "";
        let total = 0;

        cartItems.forEach((item) => {
          const itemTotal = Number(item.price) * Number(item.quantity);
          total += itemTotal;
          html += `
            <div class="checkout-item">
              <img src="${item.image}" alt="${item.name} Image">
              <div class="checkout-details">
                <h3>${item.name}</h3>
                <p>${item.description || ""}</p>
                <p class="price">Price: ${egp(item.price)} × ${item.quantity} = <strong>${egp(itemTotal)}</strong></p>
              </div>
            </div>
          `;
        });

        paymentContainer.innerHTML = html;
        totalEl.innerHTML = `<h2 style="color:#fff;">Total: ${egp(total)}</h2>`;
      }

      window.addEventListener("DOMContentLoaded", displayPaymentDetails);
    </script>

    <!-- إرسال الطلب إلى دالة Supabase -->
    <script type="module">
      import { FUNCTIONS_BASE } from './config.js';

      const form = document.getElementById('payment-form');
      const msg  = document.getElementById('form-msg');

      function loadCart(){
        try { return JSON.parse(localStorage.getItem('cartItems')) || []; }
        catch { return []; }
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.textContent = '';

        const name    = document.getElementById('name').value.trim();
        const phone   = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const vfNo    = document.getElementById('vodafone-number').value.trim();

        const cart = loadCart();
        if (!cart.length){
          alert('السلة فاضية.');
          return;
        }

        // لازم العناصر يكون فيها id (UUID) من الداتابيز
        const missingId = cart.find(it => !it.id);
        if (missingId){
          alert('في عنصر بالسلة بدون معرف (id). من فضلك أضِفه من صفحة السوق مرة أخرى.');
          return;
        }

        const items = cart.map(it => ({
          product_id: it.id,
          quantity: Number(it.quantity || 1),
        }));

        // تعطيل الزر أثناء الإرسال
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = 'Processing...';

        try{
          const res = await fetch(`${FUNCTIONS_BASE}/checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items,
              customer: { name, phone, address, vodafone_number: vfNo }
            })
          });

          const data = await res.json().catch(()=> ({}));
          if (!res.ok){
            msg.className = 'error';
            msg.textContent = data?.error || 'Unexpected error';
            btn.disabled = false; btn.textContent = 'Confirm Payment';
            return;
          }

          // Success
          msg.className = 'success';
          msg.textContent = `Order created successfully. Order ID: ${data.order_id} — Total: ${data.total} EGP`;
          alert(`Order placed!\nOrder ID: ${data.order_id}\nTotal: ${data.total} EGP`);

          localStorage.removeItem('cartItems');
          window.location.href = 'index.html';
        }catch(err){
          msg.className = 'error';
          msg.textContent = err?.message || 'Network error';
          btn.disabled = false; btn.textContent = 'Confirm Payment';
        }
      });
    </script>
  </body>
</html>
